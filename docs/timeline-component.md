# Timeline Component Documentation

## Overview

The timeline component provides a visual representation of video markers organized in swimlanes. It displays markers at their correct temporal positions, supports zooming, and integrates with the video player through a synchronized playhead.

## Core Concepts

### Markers

**Temporal Properties:**
- Markers must have a start time indicating when the marker begins
- Markers can optionally have an end time indicating when the marker ends
- Markers without an end time are displayed as very narrow bars (just wide enough to be clickable)
- Markers with both start and end times are displayed as horizontal bars spanning the duration

**Tag Structure:**
- Each marker has a single primary tag (e.g., "Dress", "Blowjob")
- Markers can have additional metadata tags (e.g., "Marker Status: Confirmed")
- Example: A "Dress" marker can have an additional "Marker Status: Confirmed" tag

**Marker States:**
Markers are visually distinguished by color based on their status:
- **Unprocessed**: Markers needing review (yellow)
- **Confirmed**: Approved markers (green)
- **Rejected**: Rejected markers (red)

### Swimlanes

**Swimlane Assignment:**
- Markers with exactly the same primary tag are on the same swimlane
- Markers with corresponding primary tags share the same swimlane
- Swimlanes maintain consistent height regardless of zoom level
- Multi-track swimlanes are used when markers overlap temporally

**Corresponding Tags:**
- Tags can be configured as "corresponding" to each other
- Typical use case: AI-generated tags (e.g., "Blowjob_AI") correspond to permanent tags (e.g., "Blowjob")
- When an AI-tagged marker is confirmed, it can be converted to its corresponding permanent tag
- Corresponding tags share the same swimlane

### Marker Groups

**Grouping:**
- Swimlanes can be organized into marker groups
- Example: Clothing swimlanes (Dress, No Underwear, Nude) form a single marker group
- Each marker group displays its own group title

**Ordering:**
- Marker groups can be sorted by the user in settings
- Swimlanes within a marker group can also be sorted by the user in settings
- This provides a customizable hierarchy

### Timeline

**Time Axis:**
- Horizontal axis represents video time
- Markers are positioned based on their start and end times
- Timeline supports zooming (horizontal time axis only)
- Zoom is relative to fit-to-window baseline (1.0 = fit to window, 1.5 = 1.5x fit, etc.)

**Timeline Header:**
- Displays time axis with minute tick marks
- Can display shot boundary markers indicating cuts in the video
- Shot boundary markers are identified by the MARKER_SHOT_BOUNDARY tag
- These are typically generated by PySceneDetect
- Click-to-seek functionality

**Playhead:**
- Vertical orange line showing the current video position
- Rendered in swimlane area only (not in header)
- Kept in sync with the video player
- Provides temporal reference for marker review

**Swimlane Resizing:**
- Keyboard shortcuts: Cmd/Ctrl + Arrow Up/Down
- Maintains minimum height constraint
- Respects maximum height to prevent covering video player

## Visual Design

### Color Coding
- Green: Confirmed markers
- Red: Rejected markers
- Yellow/Gold: Unprocessed markers
- Orange: Playhead indicator
- Different opacity levels indicate selection state

### Layout
- Left side: Fixed swimlane labels showing tag names and status counts
- Right side: Scrollable timeline grid with markers positioned temporally
- Top: Fixed timeline header with time axis and optional shot boundaries
- Synchronized horizontal scrolling between header and swimlanes
- Independent vertical scrolling for swimlanes

## Component Public API

### Props (TimelineProps)

**Required Props:**
- `markers: SceneMarker[]` - All scene markers
- `videoDuration: number` - Total video duration in seconds
- `currentTime: number` - Current playback position in seconds
- `onMarkerClick: (marker: SceneMarker) => void` - Handler for marker click events
- `selectedMarkerId: string | null` - ID of the currently selected marker

**Optional Props:**
- `showShotBoundaries?: boolean` - Display shot boundaries in timeline header (default: true)
- `scene?: Scene` - Scene data for additional context (reserved for sprite preview)
- `zoom?: number` - Timeline zoom level (default: 1.0 = fit-to-window)
- `onSwimlaneDataUpdate?: (tagGroups: TagGroup[], markersWithTracks: MarkerWithTrack[]) => void` - Callback with organized marker data for keyboard navigation
- `onAvailableWidthUpdate?: (availableWidth: number) => void` - Callback with timeline's available width for calculations

### Ref Methods (TimelineRef)

The component exposes the following methods via ref:
- `centerOnPlayhead(): void` - Scrolls the timeline to center the playhead in the viewport

### Usage Example

```tsx
const timelineRef = useRef<TimelineRef>(null);

<Timeline
  ref={timelineRef}
  markers={allMarkers}
  videoDuration={video.duration}
  currentTime={playbackTime}
  onMarkerClick={handleMarkerClick}
  selectedMarkerId={selectedId}
  showShotBoundaries={true}
  scene={sceneData}
  zoom={zoomLevel}
  onSwimlaneDataUpdate={handleSwimlaneData}
  onAvailableWidthUpdate={handleWidthUpdate}
/>

// Center playhead programmatically
timelineRef.current?.centerOnPlayhead();
```

## Implementation

### Component Architecture

The Timeline component is built from five sub-components:

1. **[TimelineAxis](../src/components/timeline-redux/TimelineAxis.tsx)** - Time axis header
   - Renders minute tick marks with time labels
   - Displays shot boundary markers (if enabled)
   - Click-to-seek functionality
   - Hover callbacks for sprite previews (future feature)

2. **[TimelineLabels](../src/components/timeline-redux/TimelineLabels.tsx)** - Swimlane label column
   - Fixed left column showing tag names
   - Displays marker group prefixes
   - Shows status counts (confirmed/rejected/pending)
   - Handles multi-track swimlanes
   - Visual selection highlighting

3. **[TimelineGrid](../src/components/timeline-redux/TimelineGrid.tsx)** - Main marker display area
   - Renders swimlane rows with markers
   - Handles multi-track swimlanes for overlapping markers
   - Interactive marker tooltips
   - Integrates TimelineMarkerBar and TimelinePlayhead

4. **[TimelineMarkerBar](../src/components/timeline-redux/TimelineMarkerBar.tsx)** - Individual marker rendering
   - Color-coded by status (confirmed/rejected/unprocessed)
   - Click handling
   - Selection state

5. **[TimelinePlayhead](../src/components/timeline-redux/TimelinePlayhead.tsx)** - Playhead indicator
   - Vertical orange line showing current time
   - Rendered in swimlane area only

### Core Business Logic

The timeline uses pure functions from the core layer:

**[markerGrouping.ts](../src/core/marker/markerGrouping.ts)**:
- `groupMarkersByTags()` - Groups markers by primary tag with corresponding tag support
- `createMarkersWithTracks()` - Assigns tracks to handle overlapping markers
- `getTrackCountsByGroup()` - Calculates max tracks per tag group
- `getMarkerGroupName()` - Extracts marker group info

**[markerLogic.ts](../src/core/marker/markerLogic.ts)**:
- `isMarkerConfirmed()`, `isMarkerRejected()`, `isUnprocessed()` - Status checks
- `getMarkerStatus()` - Get marker status enum
- `isShotBoundaryMarker()` - Identify shot boundaries
- `calculateMarkerSummary()` - Calculate status counts

**[timeline/calculations.ts](../src/core/timeline/calculations.ts)**:
- `calculateTimelineWidth()` - Timeline width based on zoom and duration
- `timeToPixels()`, `pixelsToTime()` - Position conversions
- `calculateMarkerPosition()` - Marker positioning
- `calculatePlayheadPosition()` - Playhead positioning
- `calculateCenterScrollPosition()` - Centering calculations

### Directory Structure

```
src/components/timeline-redux/
├── Timeline.tsx               # Main integration component
├── TimelineMarkerBar.tsx      # Individual marker
├── TimelinePlayhead.tsx       # Playhead indicator
├── TimelineGrid.tsx           # Marker grid
├── TimelineLabels.tsx         # Label column
├── TimelineAxis.tsx           # Time axis
└── __tests__/                 # Component tests (105 tests)

src/core/timeline/
├── calculations.ts            # Pure calculation functions
└── calculations.test.ts       # Unit tests

src/core/marker/
├── markerGrouping.ts          # Marker organization logic
├── markerLogic.ts             # Status and filtering logic
└── types.ts                   # Type definitions
```

### Key Features

**Scroll Synchronization**: Header and swimlanes scroll horizontally in sync using shared scroll event handlers.

**Swimlane Resizing**: Keyboard shortcuts (Cmd/Ctrl + Arrow Up/Down) adjust swimlane container height while respecting constraints.

**Auto-scroll to Selection**: When a marker is selected, the timeline automatically scrolls to center it in view.

**Zoom Integration**: Zoom is calculated relative to fit-to-window baseline using [useTimelineZoom](../src/hooks/useTimelineZoom.ts) hook.

**Redux Integration**: Uses selectors for marker group configuration, tag sorting, and status tag IDs.

**Responsive Dimensions**: Tracks container width via [useThrottledResize](../src/hooks/useThrottledResize.ts) hook.

### Testing

The timeline has comprehensive test coverage:
- **105 component tests** across all sub-components
- **Unit tests** for calculation functions
- Edge cases covered (zero duration, extreme zoom, overlaps, etc.)
