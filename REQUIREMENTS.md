# Requirements Documentation

This should not deal with the details of the code. It should document high-level requirements.

## Configuration

The application requires configuration to connect to the Stashapp backend and define specific tag IDs for various system functions. Configuration is provided via a JSON file with the following structure:

```json
{
  "serverConfig": { ... },
  "markerConfig": { ... },
  "markerGroupingConfig": { ... },
  "shotBoundaryConfig": { ... },
  "videoPlaybackConfig": { ... }
}
```

### Server Configuration

- **url**: The complete URL to the Stashapp GraphQL endpoint (e.g., "http://localhost:9999/graphql")
- **apiKey**: Authentication key for accessing the Stashapp API (leave empty if no authentication required)

### Marker Configuration

- **statusConfirmed**: Tag ID for markers that have been approved/confirmed by the user
- **statusRejected**: Tag ID for markers that have been rejected by the user
- **sourceManual**: Tag ID indicating markers were created manually within the application
- **aiReviewed**: Tag ID for tracking scenes that have been reviewed for AI feedback collection

### Marker Grouping Configuration

- **markerGroupParent**: Tag ID that serves as the parent tag for all marker group organization tags

### Shot Boundary Configuration

- **aiTagged**: Tag ID for scenes that have been processed by AI tagging systems
- **shotBoundary**: Tag ID for markers that represent scene transitions or shot boundaries
- **sourceShotBoundaryAnalysis**: Tag ID indicating markers were created via automated shot boundary detection
- **shotBoundaryProcessed**: Tag ID for scenes that have been processed/reviewed by shot boundary analysis

### Video Playback Configuration

- **smallSeekTime**: Time interval in seconds for small seeks (default: 5)
- **mediumSeekTime**: Time interval in seconds for medium seeks (default: 10)
- **longSeekTime**: Time interval in seconds for long seeks (default: 30)
- **smallFrameStep**: Frame count for small frame steps (default: 1)
- **mediumFrameStep**: Frame count for medium frame steps (default: 10)
- **longFrameStep**: Frame count for long frame steps (default: 30)

### Configuration Requirements

- All tag IDs must correspond to existing tags in the Stashapp database. If no suitable tags not available, those can be created from the settings views.
- The marker group parent tag must exist before creating marker group child tags, but can be created within Stash Marker Studio if needed
- Configuration is loaded at runtime and must be accessible via the application's API endpoint
- Changes to configuration require application restart to take effect
- Video playback settings should be configurable through the application settings interface

## Terminology

### Corresponding Tags vs AI Feedback

**Corresponding Tags**: Tags that have metadata relationships defined via the "Corresponding Tag: {TagName}" description field. These are used for tag grouping and conversion workflows. Any tag can be configured as a corresponding tag regardless of its source (manual, AI-generated, or otherwise).

**AI Feedback**: A separate system for collecting feedback on AI-generated markers specifically for AI model training. This functionality is distinct from the corresponding tag system and only applies to markers that were generated by AI models.

The application primarily deals with **corresponding tags** for its core workflow of tag management and marker organization. AI-specific terminology should only be used in the context of the "Collect AI Feedback" functionality.

## Marker page

### Scene Transitions

When marker page is opened, markers are grouped to swimlanes and swimlanes to marker groups. After those have been loaded, first unprocessed marker is selected top-to-bottom, left-to-right based on swimlanes. Previous scene data is immediately cleared when transitioning to prevent stale content display.

### General Navigation

#### Overview

The general navigation system provides keyboard-driven movement through the timeline interface, including swimlane navigation, zoom controls, and marker selection based on video playhead position.

#### Key Concepts

- **Swimlane navigation**: Moving between different marker categories/types
- **Timeline zoom**: Adjusting temporal resolution for detailed work
- **Playhead-based selection**: Automatic marker selection based on video position
- **Timeline centering**: Keeping important content visible during navigation

#### Navigation Shortcuts

##### Swimlane Movement

- **Up arrow**: Move to swimlane above current selection
- **Down arrow**: Move to swimlane below current selection
- **Left arrow**: Move to previous marker within current swimlane
- **Right arrow**: Move to next marker within current swimlane

##### Timeline Zoom Controls

- **Default key**: `+` (Plus)
- **Function**: Zoom in to show more temporal detail
- **Behavior**: Increases timeline resolution for precise work

- **Default key**: `-` (Minus)
- **Function**: Zoom out to show broader temporal context
- **Behavior**: Decreases timeline resolution for overview

- **Default key**: `0` (Zero)
- **Function**: Reset timeline zoom to default level
- **Behavior**: Returns to standard timeline resolution

##### Playhead-Based Marker Selection

- **Default key**: `Tab`
- **Function**: Select next marker at or after current video position
- **Scope**: Searches forward in time from playhead position
- **Behavior**: Automatically updates as video plays

- **Default key**: `Shift+Tab`
- **Function**: Select previous marker at or before current video position
- **Scope**: Searches backward in time from playhead position
- **Behavior**: Finds most recent marker relative to playhead

##### Center Timeline on Playhead

- **Default key**: `H`
- **Function**: Center timeline view on current video playhead position
- **Behavior**: Adjusts timeline scroll to keep playhead visible
- **Context**: Maintains current zoom level while adjusting position

#### Behavior Specifications

##### Swimlane Order

- Navigation follows visual swimlane order from top to bottom
- Boundary behavior stops at first/last swimlanes without wrapping
- Empty swimlanes are skipped during navigation

##### Zoom Behavior

- Zoom operations maintain playhead position as focal point
- Minimum and maximum zoom levels prevent excessive scaling
- Zoom state persists across navigation operations

##### Playhead Synchronization

- Timeline automatically follows video playback
- Manual centering overrides automatic following temporarily
- System re-enables automatic following after user inactivity

##### Expected User Experience

1. Users can quickly navigate between marker categories using arrow keys
2. Users can adjust timeline detail level for different tasks using +/-/0
3. Users can synchronize marker selection with video position using Tab/Shift+Tab
4. Users can maintain visual context during navigation using H
5. Navigation operations feel responsive and predictable
6. System maintains user orientation during complex navigation sequences

### Marker Grouping and Organization

#### Overview

The system provides two levels of marker organization: tag-based swimlane grouping and hierarchical marker groups. This allows for both automatic grouping of related markers on individual swimlanes and manual organization of multiple swimlanes into logical sections.

#### Tag-Based Swimlane Grouping

##### Corresponding Tag System

- **Same Swimlane Grouping**: Tags with "Corresponding Tag" metadata are grouped together on the same swimlane
- **Metadata-Based**: Grouping relies on the "Corresponding Tag: {TagName}" description field rather than naming conventions
- **User Control**: Users explicitly define which tags should be grouped together via tag descriptions
- **Actual Tag Display**: Swimlanes show actual tag names, making it clear what tags are being used

##### Swimlane Creation

- **Per Tag Type**: Each unique tag gets its own swimlane by default
- **Optional Grouping**: Tags are only grouped when explicitly configured via corresponding tag metadata
- **Transparent Organization**: Users can see exactly which tags are in use without hidden grouping logic
- **Track Assignment**: Overlapping markers within a swimlane use separate tracks to prevent visual conflicts
- **Alphabetical Ordering**: Swimlanes are ordered alphabetically by tag name when not part of a marker group

##### Corresponding Tag Management

- **Gear Icon Access**: Each swimlane displays a gear icon on hover for managing corresponding tag relationships
- **Two-State Interface**: Gear icon shows different interfaces based on the swimlane's corresponding tag state
- **State 1 - No Relationships**: If the swimlane's base tag has no other tags pointing to it as corresponding, shows TagAutocomplete to set a corresponding tag for any tag in the swimlane
- **State 2 - Existing Relationships**: If the swimlane's base tag has other tags pointing to it as corresponding, shows list format like "Kissing has following corresponding tags: - Kissing_AI [Remove]"
- **Individual Removal**: Each corresponding tag relationship displays its own Remove button
- **Description Field Management**: Remove buttons reset the "Corresponding Tag: {TagName}" description field of the specific tag with corresponding tag metadata
- **Real-time Updates**: Changes are immediately reflected in the timeline and trigger data refresh

#### Marker Groups

##### Overview

Marker groups provide hierarchical organization of multiple swimlanes into visually distinct sections with customizable ordering and display names.

##### Key Concepts

- **Marker Group Parent Tag**: A configured tag that serves as the parent for all marker group tags
- **Marker Group Tags**: Child tags that define specific marker groups with "Marker Group: N. Name" naming convention
- **Swimlane Grouping**: Each marker group contains multiple related swimlanes that are visually grouped together
- **Natural Ordering**: Marker groups are sorted numerically by their order number prefix

##### Tag Hierarchy

- **Parent Tag**: Configured via settings as the root for all marker group tags
- **Child Tags**: Named with pattern "Marker Group: N. DisplayName" where N is order number
- **Primary Tag Association**: Markers are grouped when their primary tag has a marker group parent

##### Swimlane Assignment

- Each marker group contains multiple swimlanes that share the same marker group classification
- Swimlanes within a group are visually grouped together in the timeline
- Groups are ordered by the numeric prefix in marker group names (1, 2, 3, etc.)
- Multiple tracks within each swimlane handle overlapping markers automatically
- Empty marker groups are excluded from timeline display

#### Configuration

##### Parent Tag Setup

- **Location**: Settings → Marker Groups → Parent Tag for Marker Groups
- **Function**: Defines which tag serves as the parent for all marker group tags
- **Persistence**: Configuration saved to server and synchronized across sessions
- **Requirement**: Must be set before creating or managing marker group tags

##### Marker Group Management

- **Creation**: Add new marker groups with custom display names
- **Automatic Naming**: System prefixes groups with "Marker Group: N." for consistent ordering
- **Drag Reordering**: Visual drag-and-drop interface for changing group order
- **Rename Operations**: Edit display names while preserving numeric ordering
- **Deletion**: Remove marker groups (with confirmation for safety)

#### Timeline Integration

##### Swimlane Display

- **Visual Separation**: Each marker group appears as a distinct section containing related swimlanes
- **Group Headers**: Marker group names are displayed above their contained swimlanes
- **Multi-Track Support**: Overlapping markers within each swimlane use separate tracks
- **Height Calculation**: Each swimlane height adjusts automatically based on track count
- **Status Indicators**: Individual swimlane and group status (confirmed/rejected) affects visual styling

##### Navigation Support

- **Keyboard Navigation**: Arrow keys move between swimlanes and markers, respecting group boundaries
- **Global Navigation**: Shift+N/M for cross-group unprocessed marker navigation
- **Selection Context**: Selected marker highlights its containing swimlane and group
- **Auto-Scroll**: Timeline automatically scrolls to show selected marker's group and swimlane

#### Behavior Specifications

##### Organization Hierarchy

- **Two-Level System**: Tag-based swimlane grouping operates independently from marker group organization
- **Swimlane Level**: Tags with corresponding tag metadata optionally group on the same swimlane
- **Group Level**: Multiple swimlanes can be manually organized into marker groups
- **Sort Order**: Marker groups sorted by numeric prefix, then swimlanes within groups alphabetically
- **Status Calculation**: Group status based on collective status of contained swimlanes

##### Visual Organization

- **Group Headers**: Marker group names are displayed as section headers above their swimlanes
- **Swimlane Grouping**: Related swimlanes are visually grouped together under their marker group
- **Track Indicators**: Multi-track swimlanes show track count in their individual labels
- **Status Colors**: Rejected swimlanes use red background, selected swimlanes use highlighted background

##### Navigation Behavior

- **Group Order**: Navigation follows marker group order (1, 2, 3, etc.) then swimlane order within groups
- **Within-Group Movement**: Arrow keys navigate between swimlanes within the current marker group
- **Cross-Group Movement**: Global navigation (Shift+N/M) searches across all marker groups and swimlanes
- **Boundary Handling**: Navigation stops at first/last items without wrapping

#### Expected User Experience

1. Users can organize related swimlanes into logical categories using marker groups
2. Users can customize the order and names of marker groups through drag-and-drop interface
3. Users can navigate efficiently between related markers using group-aware keyboard shortcuts
4. Users can visually distinguish between different marker categories through group separation
5. System automatically handles overlapping markers within swimlanes using multi-track layout
6. Configuration persists across sessions and synchronizes with server storage

### Video Playback Controls

#### Overview

The video playback control system provides comprehensive keyboard shortcuts for video navigation, including play/pause, seeking, and frame-precise stepping for detailed marker work.

#### Key Concepts

- **Play/pause control**: Basic video playback state management
- **Seeking operations**: Jumping to specific time positions
- **Frame stepping**: Frame-accurate navigation for precise work
- **Playback from markers**: Starting playback from specific marker positions

#### Playback Shortcuts

##### Play/Pause Toggle

- **Function**: Toggle between play and pause states
- **Behavior**: Immediate response without video buffering delays
- **Context**: Works regardless of current timeline focus
- **Configuration**: Should have configurable keyboard shortcuts

##### Time-Based Seeking

- **Small Seek Backward/Forward**: Seek backward/forward by configurable time interval (default: 5 seconds)
- **Medium Seek Backward/Forward**: Seek backward/forward by configurable time interval (default: 10 seconds)  
- **Long Seek Backward/Forward**: Seek backward/forward by configurable time interval (default: 30 seconds)
- **Precision**: Accurate timing based on video frame rate
- **Configuration**: All seek actions should have configurable keyboard shortcuts and time values

##### Frame-Based Stepping

- **Small Frame Step Backward/Forward**: Step backward/forward by configurable frame count (default: 1 frame)
- **Medium Frame Step Backward/Forward**: Step backward/forward by configurable frame count (default: 10 frames)
- **Long Frame Step Backward/Forward**: Step backward/forward by configurable frame count (default: 30 frames)
- **Precision**: Frame-accurate navigation for detailed work
- **Purpose**: Provides multiple levels of frame navigation granularity
- **Configuration**: All frame step actions should have configurable keyboard shortcuts and frame counts

##### Play from Marker

- **Function**: Start video playback from selected marker's start time
- **Behavior**: Automatically seeks to marker position and begins playback
- **Context**: Only active when a marker is selected
- **Configuration**: Should have configurable keyboard shortcuts

#### Behavior Specifications

##### Frame Rate Handling

- All frame operations account for video-specific frame rates
- System automatically detects frame rate from video metadata
- Fallback to 30fps when frame rate detection fails

##### Seeking Accuracy

- Seeking operations maintain frame-accurate positioning
- System handles variable frame rate videos appropriately
- Timeline updates immediately to reflect new position

##### Playback State Synchronization

- Play/pause state synchronizes between video element and UI
- Keyboard shortcuts override mouse controls when active
- System handles video loading states gracefully

##### Expected User Experience

1. Users can control video playback without mouse interaction using configurable shortcuts
2. Users can navigate video content with configurable time granularities (customizable seek intervals)
3. Users can perform frame-accurate work with configurable frame step sizes (customizable frame counts)
4. Users can efficiently move through content using appropriate granularity for their task
5. Users can start playback from specific markers using configurable shortcuts
6. Video controls feel responsive and provide immediate feedback
7. All video control actions are bindable to preferred keyboard shortcuts
8. Users can customize seek and frame step values to match their workflow preferences

### Unprocessed Marker Navigation

#### Overview

The unprocessed marker navigation system provides keyboard shortcuts for efficiently navigating between markers that need review (unprocessed markers) in the timeline. The system respects swimlane organization and implements strict boundary behavior.

#### Key Concepts

- **Unprocessed markers**: Markers that have not been confirmed or rejected by the user
- **Swimlane-scoped navigation**: Navigation within the currently selected marker's swimlane only
- **Global navigation**: Cross-swimlane navigation that searches all swimlanes in order
- **No rollover**: Navigation stops at boundaries instead of wrapping around to the beginning/end

#### Navigation Shortcuts

##### Previous Unprocessed (Swimlane Scoped)

- **Default key**: `N`
- **Function**: Navigate to the previous unprocessed marker within the current swimlane
- **Scope**: Current swimlane only
- **Boundary behavior**: If already at the first unprocessed marker in the swimlane, selection remains unchanged
- **Search direction**: Backwards in time within the swimlane

##### Next Unprocessed (Swimlane Scoped)

- **Default key**: `M`
- **Function**: Navigate to the next unprocessed marker within the current swimlane
- **Scope**: Current swimlane only
- **Boundary behavior**: If already at the last unprocessed marker in the swimlane, selection remains unchanged
- **Search direction**: Forwards in time within the swimlane

##### Previous Unprocessed (Global)

- **Default key**: `Shift+N`
- **Function**: Navigate to the previous unprocessed marker across all swimlanes
- **Scope**: All swimlanes
- **Search pattern**: Searches backwards through swimlanes (bottom-to-top in UI, right-to-left in time)
- **Boundary behavior**: Stops at the first unprocessed marker globally, no wrap-around

##### Next Unprocessed (Global)

- **Default key**: `Shift+M`
- **Function**: Navigate to the next unprocessed marker across all swimlanes
- **Scope**: All swimlanes
- **Search pattern**: Searches forwards through swimlanes (top-to-bottom in UI, left-to-right in time)
- **Boundary behavior**: Stops at the last unprocessed marker globally, no wrap-around

#### Behavior Specifications

##### Initial Selection

- On page load, automatically selects the first unprocessed marker found in swimlane order
- Waits for timeline data to be fully loaded before attempting selection
- Does not fall back to chronological selection if swimlane data is unavailable

##### Search Order

- **Within swimlanes**: Markers are ordered by timestamp (earliest to latest)
- **Between swimlanes**: Follows the visual swimlane order (top-to-bottom in UI)
- **Global navigation**: Respects both temporal order within swimlanes and swimlane hierarchy

##### Edge Cases

- If no unprocessed markers exist, navigation commands have no effect
- If current marker is the only unprocessed marker in scope, selection remains unchanged
- When current swimlane has no additional unprocessed markers, global navigation continues to adjacent swimlanes

#### Expected User Experience

1. Users can quickly review unprocessed markers within a specific category using N/M keys
2. Users can jump between categories to find the next unprocessed marker using Shift+N/M
3. Navigation is predictable and never "wraps around" unexpectedly
4. The system provides efficient workflow for marker review tasks

### Marker Confirmation and Rejection

#### Overview

The marker confirmation and rejection system allows users to approve or reject markers during review. The system uses toggle behavior where repeated presses of the same key cycle between the action state and unprocessed.

#### Key Concepts

- **Confirmed markers**: Markers approved by the user, tagged with MARKER_STATUS_CONFIRMED
- **Rejected markers**: Markers rejected by the user, tagged with MARKER_STATUS_REJECTED
- **Toggle behavior**: Repeated confirm/reject actions toggle the marker back to unprocessed
- **State cycling**: Actions cycle through states rather than being idempotent

#### Confirmation/Rejection Shortcuts

##### Confirm Marker

- **Default key**: `Z`
- **Function**: Toggle marker between confirmed and unprocessed states
- **Behavior**:
  - Unprocessed → Confirmed (adds MARKER_STATUS_CONFIRMED tag)
  - Confirmed → Unprocessed (removes MARKER_STATUS_CONFIRMED tag)
  - Rejected → Confirmed (removes MARKER_STATUS_REJECTED, adds MARKER_STATUS_CONFIRMED)

##### Reject Marker

- **Default key**: `X`
- **Function**: Toggle marker between rejected and unprocessed states
- **Behavior**:
  - Unprocessed → Rejected (adds MARKER_STATUS_REJECTED tag)
  - Rejected → Unprocessed (removes MARKER_STATUS_REJECTED tag)
  - Confirmed → Rejected (removes MARKER_STATUS_CONFIRMED, adds MARKER_STATUS_REJECTED)

##### Delete All Rejected Markers

- **Default key**: `Shift+X`
- **Function**: Initiate bulk deletion of all markers with rejected status
- **Behavior**: Opens confirmation dialog before permanent deletion
- **Safety**: Requires explicit confirmation to prevent accidental data loss

#### Behavior Specifications

##### State Transitions

- **From Unprocessed**: Z confirms, X rejects
- **From Confirmed**: Z toggles back to unprocessed, X changes to rejected
- **From Rejected**: X toggles back to unprocessed, Z changes to confirmed
- **Toggle behavior**: Repeated presses of the same key toggle between that state and unprocessed

##### Expected User Experience

1. Users can quickly confirm markers they approve using Z
2. Users can quickly reject markers they disapprove using X
3. Users can toggle markers back to unprocessed by pressing the same key again
4. State changes follow predictable toggle patterns
5. Users can easily correct mistakes by repeating the same action

### Marker Creation

#### Overview

The marker creation system provides multiple methods for creating new markers, including regular markers, shot boundary markers, marker duplication, and marker splitting operations.

#### Key Concepts

- **Regular markers**: Standard action markers created at current video position
- **Shot boundary markers**: Special markers for scene transitions (PySceneDetect integration)
- **Marker duplication**: Creating copies of existing markers with identical properties
- **Marker splitting**: Dividing existing markers into multiple segments

#### Creation Shortcuts

##### Create Regular Marker

- **Default key**: `A`
- **Function**: Create new marker at current video position
- **Duration**: Default 20-second duration from current time
- **Behavior**: Enters creation mode allowing immediate tag assignment

##### Create Shot Boundary Marker

- **Default key**: `Shift+A`
- **Function**: Create shot boundary marker at current position
- **Purpose**: Mark scene transitions or cuts for video editing workflow
- **Tags**: Automatically applies shot boundary classification tags

##### Duplicate Current Marker

- **Default key**: `D`
- **Function**: Create exact copy of currently selected marker
- **Timing**: Uses same start/end times as source marker
- **Properties**: Copies all tags and metadata from source marker
- **Selection**: Automatically selects the new duplicate marker

##### Split Current Marker

- **Default key**: `S`
- **Function**: Split selected marker at current video position
- **Result**: Creates two markers from one, dividing at playhead position
- **Properties**: Both resulting markers inherit original properties

##### Split Video Cut Marker

- **Default key**: `V`
- **Function**: Specialized split operation for video editing workflows
- **Purpose**: Create markers aligned with video editing cuts or transitions

#### Behavior Specifications

##### Creation Modes

- Creation operations enter temporary editing mode
- New markers appear immediately in timeline
- Escape key cancels creation and removes temporary markers
- Completion saves markers to database and applies tags

##### Default Properties

- New markers inherit appropriate default tags based on creation method
- Regular markers use current tag selection context
- Shot boundary markers apply predefined system tags
- Duplicated markers maintain all original properties

##### Expected User Experience

1. Users can quickly create markers during video review using A
2. Users can mark shot boundaries for editing workflows using Shift+A
3. Users can duplicate good markers to save time using D
4. Users can divide long markers into segments using S
5. Creation operations provide immediate visual feedback
6. System supports rapid marker creation without interrupting video flow

### Marker Editing

#### Overview

The marker editing system provides comprehensive tools for modifying marker properties, including tag assignment, timing adjustments, and advanced operations like copying and merging marker data.

#### Key Concepts

- **Tag editing**: Modifying marker classifications and metadata
- **Time adjustment**: Precise control over marker start and end times
- **Copy/paste operations**: Transferring timing data between markers
- **Marker merging**: Combining properties from multiple markers

#### Editing Shortcuts

##### Edit Marker Tag

- **Default key**: `Q`
- **Function**: Open tag editing interface for selected marker
- **Scope**: Allows modification of all marker tags and properties
- **Interface**: Modal or inline editing depending on context

##### Set Marker Start Time

- **Default key**: `W`
- **Function**: Set marker start time to current video position
- **Precision**: Frame-accurate timing based on video frame rate
- **Validation**: Ensures start time does not exceed end time

##### Set Marker End Time

- **Default key**: `E`
- **Function**: Set marker end time to current video position
- **Precision**: Frame-accurate timing based on video frame rate
- **Validation**: Ensures end time is not before start time

##### Copy Marker Times

- **Default key**: `T`
- **Function**: Copy start and end times of selected marker to clipboard
- **Storage**: Times stored in memory for pasting to other markers
- **Format**: Preserves precise timing data for accurate transfer

##### Paste Marker Times

- **Default key**: `Shift+T`
- **Function**: Apply previously copied times to selected marker
- **Behavior**: Updates both start and end times simultaneously
- **Requirements**: Must have previously copied times from another marker

##### Copy Marker for Merge

- **Default key**: `R`
- **Function**: Copy selected marker properties for merging with another marker
- **Data**: Captures all marker metadata including tags and timing
- **Purpose**: First step in marker merging workflow

##### Merge Marker Properties

- **Default key**: `Shift+R`
- **Function**: Merge previously copied marker properties with selected marker
- **Behavior**: Combines tags and properties from both markers
- **Conflict resolution**: System-defined rules for handling duplicate properties

#### Behavior Specifications

##### Time Precision

- All timing operations use frame-accurate precision
- System accounts for variable frame rates across different video files
- Timing validation prevents invalid marker configurations

##### Property Inheritance

- Merged markers combine properties intelligently
- Conflicting properties follow predefined resolution rules
- System maintains data integrity throughout merge operations

##### Expected User Experience

1. Users can quickly modify marker tags using Q
2. Users can set precise marker boundaries using W/E while watching video
3. Users can transfer timing between similar markers using T/Shift+T
4. Users can combine marker properties efficiently using R/Shift+R
5. Editing operations provide immediate visual feedback
6. System prevents invalid marker configurations through validation

### Video Jump Navigation

#### Overview

The video jump navigation system provides shortcuts for quickly moving to specific positions within the video, including marker boundaries, scene boundaries, and shot transitions.

#### Key Concepts

- **Marker boundaries**: Jumping to start/end positions of selected marker
- **Scene boundaries**: Navigating to video beginning/end
- **Shot navigation**: Moving between detected shot boundaries
- **Contextual jumping**: Navigation that respects current selection state

#### Jump Navigation Shortcuts

##### Jump to Marker Boundaries

- **Default key**: `I`
- **Function**: Jump to start time of currently selected marker
- **Behavior**: Seeks video to marker's start position without changing playback state

- **Default key**: `O`
- **Function**: Jump to end time of currently selected marker
- **Behavior**: Seeks video to marker's end position (or start + 30s if no end time)

##### Jump to Scene Boundaries

- **Default key**: `Shift+I`
- **Function**: Jump to beginning of current scene/video
- **Position**: Seeks to 0:00 timestamp
- **Context**: Useful for reviewing entire scene content

- **Default key**: `Shift+O`
- **Function**: Jump to end of current scene/video
- **Position**: Seeks to final timestamp of video
- **Context**: Useful for checking scene completion

##### Shot Boundary Navigation

- **Default key**: `Y`
- **Function**: Jump to previous shot boundary
- **Integration**: Uses PySceneDetect shot boundary data when available
- **Fallback**: Uses manual shot boundary markers if auto-detection unavailable

- **Default key**: `U`
- **Function**: Jump to next shot boundary
- **Integration**: Uses PySceneDetect shot boundary data when available
- **Fallback**: Uses manual shot boundary markers if auto-detection unavailable

#### Behavior Specifications

##### Marker Context Requirements

- Marker boundary jumps require an active marker selection
- System provides feedback when no marker is selected
- Invalid markers (no timing data) are handled gracefully

##### Shot Boundary Integration

- Shot boundaries come from PySceneDetect integration when available
- Manual shot boundary markers serve as backup navigation points
- System intelligently combines automatic and manual shot data

##### Jump Accuracy

- All jump operations use frame-accurate positioning
- System accounts for video-specific timing requirements
- Edge cases (missing data, invalid positions) are handled safely

##### Expected User Experience

1. Users can quickly navigate to marker boundaries for review using I/O
2. Users can jump to scene start/end for context using Shift+I/O
3. Users can move between shots efficiently using Y/U
4. Jump operations provide immediate visual feedback
5. System maintains video context during navigation jumps
6. Navigation feels predictable and supports rapid review workflows

### AI Feedback Collection

#### Overview

The AI feedback collection system provides tools for collecting feedback on AI-generated markers to improve AI model training. This system operates independently from marker states and allows users to flag problematic AI predictions while automatically rejecting the markers.

#### Key Concepts

- **AI feedback collection**: Independent system for tracking AI model errors
- **Automatic rejection**: Markers are automatically rejected when added to feedback collection
- **Persistent storage**: Feedback data persists independently of marker lifecycle
- **Screengrab generation**: Client automatically captures video frames for each collected marker
- **Export capability**: Feedback data can be downloaded as organized zip files

#### AI Feedback Shortcuts

##### Add/Remove AI Feedback Collection

- **Default key**: `C`
- **Function**: Toggle marker between AI feedback collection and normal state
- **Behavior**:
  - **When marker is NOT in AI feedback collection**:
    - Adds marker to AI feedback collection storage
    - Automatically rejects the marker (adds MARKER_STATUS_REJECTED tag)
    - Persists feedback data independently of marker state
  - **When marker IS in AI feedback collection**:
    - Removes marker from AI feedback collection storage
    - If marker is currently rejected, automatically unrejects it (removes MARKER_STATUS_REJECTED tag)
    - Cleans up associated feedback data
- **Toggle behavior**: Repeated presses cycle between AI feedback collection state and normal state
- **Storage**: Uses local storage to persist AI feedback data across sessions

##### Open AI Feedback Modal

- **Default key**: `Shift+C`
- **Function**: Open modal interface for managing AI feedback collection
- **Scope**: Displays all markers currently in AI feedback collection
- **Features**:
  - Review collected feedback items
  - Preview captured screengrabs
  - Download feedback as zip file
  - Remove items from collection

#### Behavior Specifications

##### AI Feedback Data Management

- AI feedback data is stored locally with complete marker metadata
- Includes marker timing, tag information, scene context, and video screengrabs
- Data persists independently of marker lifecycle (markers can be deleted without losing feedback)
- Feedback collection survives browser sessions and application restarts
- No automatic sync with server - data remains local until explicitly exported

##### Screengrab Capture

- Screengrabs are captured during the export process for each collected marker
- Screengrabs are organized by marker for easy review
- Images are generated and included in the exported zip file
- Supports various video formats and resolutions

##### Export Functionality

- Feedback data exported as organized zip file
- Contains marker metadata and associated screengrabs
- Grouped by scene/marker for easy analysis
- Suitable for AI model training feedback workflows

##### Expected User Experience

1. Users can quickly flag problematic AI markers for training feedback using C
2. Users can access comprehensive feedback management interface using Shift+C
3. Users can export organized feedback packages for AI model improvement
4. System captures relevant visual context when exporting feedback data
5. Feedback collection operates independently of normal marker workflow
6. Users can safely delete markers knowing feedback data is preserved

### System Operations

#### Overview

The system operations provide essential application control functions, including escape handling for canceling operations, modal dialog management, and state recovery mechanisms.

#### Key Concepts

- **Escape handling**: Universal cancel operation for various application modes
- **Modal management**: Keyboard control for dialog interactions
- **State recovery**: Graceful handling of interrupted operations
- **Mode detection**: Context-aware behavior based on current application state

#### System Shortcuts

##### Escape Key Handling

- **Default key**: `Escape`
- **Function**: Context-sensitive cancel operation
- **Behaviors**:
  - **During marker editing**: Cancel edit and restore original marker state
  - **During marker creation**: Remove temporary marker and exit creation mode
  - **During marker duplication**: Cancel duplication and restore original selection
  - **In normal mode**: No action (prevents accidental state changes)

##### Modal Dialog Controls

- **Default key**: `Enter` (in modal context)
- **Function**: Confirm modal dialog action
- **Scope**: Works in completion modal and deletion confirmation dialog
- **Priority**: Modal shortcuts take precedence over normal shortcuts

- **Default key**: `Escape` (in modal context)
- **Function**: Cancel modal dialog action
- **Scope**: Closes any open modal without executing action
- **Safety**: Prevents accidental destructive operations

#### Behavior Specifications

##### Context Detection

- System automatically detects current application mode
- Escape behavior adapts to current operation context
- Modal state takes priority over normal operation shortcuts

##### State Recovery

- Interrupted operations restore application to previous stable state
- Temporary data (like temp markers) is cleaned up automatically
- User selections are preserved when safe to do so

##### Error Handling

- System handles invalid states gracefully without crashes
- User feedback provided for failed operations
- Recovery mechanisms restore application functionality

##### Expected User Experience

1. Users can cancel any operation safely using Escape
2. Users can confirm modal actions quickly using Enter
3. Users can abandon operations without losing work
4. System behavior is predictable across different modes
5. Error states are resolved automatically when possible
6. Application maintains stable state throughout complex operations

## Implementation Notes

### Keyboard Shortcut Architecture

- All shortcuts are managed through the `KeyboardShortcutService`
- Dynamic registration allows for customizable key bindings
- Conflict resolution ensures single action per key combination
- Context awareness prevents inappropriate action execution

### Integration Requirements

- **Stashapp Backend**: GraphQL mutations for marker operations
- **PySceneDetect**: Optional integration for automatic shot boundary detection
- **Local Storage**: Persistent incorrect marker tracking
- **Video Element**: Direct integration for frame-accurate seeking

### Performance Considerations

- Keyboard handlers use event delegation for efficiency
- State updates are batched to prevent excessive re-renders
- Video seeking operations are debounced for smooth playback
- Memory management for large marker datasets

### Accessibility Features

- Keyboard-first design supports assistive technologies
- Visual feedback for all keyboard operations
- Clear focus indicators throughout the interface
- Screen reader compatible shortcuts and labels
